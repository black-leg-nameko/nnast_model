# NNAST これからの戦略

## 現状分析（設計書v2との整合性チェック）

### ✅ 実装済み

1. **CPG Generator** (設計書 4章)
   - ✅ AST + CFG + DFG + DDFG の生成
   - ✅ ノード属性（is_source/is_sink/sanitizer_kind）の付与
   - ✅ YAMLベースのパターンマッチング統合
   - ✅ フレームワーク検出とメタデータ付与

2. **Node Embedding** (設計書 5.1)
   - ✅ CodeBERTによるトークン埋め込み
   - ✅ 静的特徴量（型、役割、属性フラグ）の結合

3. **GNN Encoder** (設計書 5.2)
   - ✅ GAT（Graph Attention Network）
   - ✅ Dynamic Attention Fusion Layer
   - ✅ Edge type-aware attention

4. **パターン定義** (設計書 3.2, 4.4)
   - ✅ patterns.yamlによる15パターンの定義
   - ✅ Source/Sink/Sanitizerの共通辞書化
   - ✅ フレームワーク差の吸収

5. **データセット設計** (設計書 6章)
   - ✅ 合成データ生成
   - ✅ 実在修正コミット収集
   - ✅ Project-split / Time-split戦略

### ✅ 新規実装完了（優先度1-4）

1. **OWASP Top 10 Mapping** (設計書 3.3, 5.3)
   - ✅ patterns.yamlにowasp/cwe情報は定義済み
   - ✅ 推論結果へのマッピング機能を実装（`ml/owasp_mapper.py`）
   - ✅ 設計書5.3の出力フォーマットを実装
   - ✅ `--owasp-format`オプションで出力形式を選択可能

2. **評価指標** (設計書 7章)
   - ✅ Macro-F1, Per-class F1, PR-AUCの実装完了（`ml/evaluation.py`）
   - ✅ ローカライズ精度（行レベル）の評価を実装
   - ✅ フレームワーク別性能評価を実装
   - ✅ sklearnなしでも動作するフォールバック実装

3. **データセット品質検証** (優先度3)
   - ✅ データセット品質検証ツールを実装（`data/validate_dataset.py`）
   - ✅ 7つの検証機能（Graph-Label Alignment, Pattern Distribution, Framework Distribution等）
   - ✅ JSON形式での結果出力

4. **パターンマッチング改善** (優先度4)
   - ✅ エイリアス検出の改善（`from flask import request`対応）
   - ✅ SAN_SQL_PARAMの条件付き判定（プレースホルダー検出）
   - ✅ より詳細な制約チェック（ASTノードレベル）

### ❌ 未実装

1. **Phase II: Fix Recommendation** (設計書 8章)
   - 将来拡張として保留

---

## 優先度別の実装戦略

### 🔴 優先度1: OWASPマッピングの完全実装（最重要）

**目的**: 設計書の「二層ラベル構造」を完成させる

**実装内容**:
1. Pattern ID → OWASP/CWE マッピングモジュールの作成
2. 推論結果にOWASP/CWE情報を付与
3. 設計書5.3の出力フォーマット実装

**実装ファイル**:
- `ml/owasp_mapper.py` (新規)
- `ml/inference.py` (更新)

**出力フォーマット例**:
```json
{
  "pattern_id": "SSRF_REQUESTS_URL_TAINTED",
  "cwe_id": "CWE-918",
  "owasp": "A10: SSRF",
  "confidence": 0.94,
  "location": {
    "file": "views.py",
    "lines": [42, 48]
  }
}
```

### 🟡 優先度2: 評価指標の実装

**目的**: 研究としての再現性と説得力を確保

**実装内容**:
1. Macro-F1, Per-class F1, PR-AUCの計算
2. ローカライズ精度（行レベル）の評価
3. フレームワーク別性能評価
4. 評価スクリプトの作成

**実装ファイル**:
- `ml/evaluation.py` (新規)
- `ml/train.py`, `ml/train_nodepair.py` (更新)

### 🟢 優先度3: データセット品質の向上

**目的**: 学習データの質を確保

**実装内容**:
1. データセット品質検証ツール
2. パターンID別のデータ分布確認
3. フレームワーク別のデータ分布確認
4. 合成データと実在データのバランス確認

**実装ファイル**:
- `data/validate_dataset.py` (新規)

### 🔵 優先度4: パターンマッチングの改善

**目的**: 検出精度の向上

**実装内容**:
1. エイリアス検出の改善（`from flask import request`対応）
2. SAN_SQL_PARAMの条件付き判定（placeholder判定）
3. より詳細な制約チェック

**実装ファイル**:
- `cpg/pattern_matcher.py` (更新)

---

## 短期ロードマップ（1-2週間）

### ✅ Week 1: OWASPマッピング実装（完了）

**Day 1-2**: Pattern ID → OWASP/CWE マッピングモジュール
- [x] `ml/owasp_mapper.py`の作成
- [x] patterns.yamlからマッピング情報を読み込み
- [x] テストコードの作成

**Day 3-4**: 推論結果への統合
- [x] `ml/inference.py`の更新
- [x] 設計書5.3の出力フォーマット実装
- [x] 既存コードとの統合テスト

**Day 5**: ドキュメントとテスト
- [x] 使用例の作成
- [x] 統合テストの実行
- [x] ドキュメント更新

### ✅ Week 2: 評価指標実装（完了）

**Day 1-2**: 基本評価指標
- [x] Macro-F1, Per-class F1の実装
- [x] PR-AUCの実装
- [x] テストコードの作成

**Day 3-4**: 詳細評価指標
- [x] ローカライズ精度（行レベル）の評価
- [x] フレームワーク別性能評価
- [x] 評価スクリプトの作成

**Day 5**: 統合とテスト
- [x] 既存の学習スクリプトへの統合
- [x] 評価結果の可視化
- [x] ドキュメント更新

---

## 中期ロードマップ（1-2ヶ月）

### ✅ データセット品質向上（完了）
- [x] データセット品質検証ツールの実装
- [x] パターンID別のデータ分布分析
- [x] 合成データと実在データのバランス調整

### ✅ パターンマッチング改善（完了）
- [x] エイリアス検出の改善
- [x] SAN_SQL_PARAMの条件付き判定実装
- [x] より詳細な制約チェック

### モデル性能向上
- ハイパーパラメータチューニング
- データ拡張の改善
- アンサンブル手法の検討

---

## 長期ロードマップ（3-6ヶ月）

### Phase II: Fix Recommendation
- CPG差分に基づく修正提案
- 人間可読なパッチ説明生成
- 修正コード生成

### 論文執筆準備
- 実験設計の確定
- 評価指標の最終化
- 限界と正直な記述の整理

---

## リスクと対策

### リスク1: OWASPマッピングの複雑性
**対策**: patterns.yamlの構造を活用し、シンプルなマッピングロジックを実装

### リスク2: 評価指標の実装コスト
**対策**: 既存のライブラリ（sklearn等）を活用し、段階的に実装

### リスク3: データセットの品質
**対策**: 品質検証ツールを早期に実装し、継続的に監視

---

## 次のアクション

### ✅ 完了した実装
1. ✅ OWASPマッピングモジュールの実装
2. ✅ 評価指標の実装
3. ✅ データセット品質検証ツールの実装
4. ✅ パターンマッチングの改善

### 🔄 次のステップ

1. **統合テストの実施**
   - CPG生成から推論までのエンドツーエンドテスト
   - 実際のデータセットでの動作確認
   - パフォーマンステスト

2. **ドキュメントの整備**
   - APIドキュメントの作成
   - 使用例の充実
   - トラブルシューティングガイド

3. **データセットの再生成**
   - パターンマッチングを有効にして既存データセットを再生成
   - Source/Sink coverageの向上

4. **モデル性能の向上**
   - ハイパーパラメータチューニング
   - データ拡張の改善
   - アンサンブル手法の検討

