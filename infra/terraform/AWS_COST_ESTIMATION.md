# NNAST AWS コスト見積もり

## 前提条件
- **リージョン**: ap-northeast-1 (東京)
- **環境**: dev環境（リリース前、アイドル状態）
- **期間**: 1日（24時間）
- **トラフィック**: なし（terraform apply後のアイドル状態）

## リソース構成

### デフォルト設定値
- ECS Fargate: 
  - Auth Service: 2タスク
  - Report Worker: 2タスク
  - CPU: 512 (0.5 vCPU) / タスク
  - Memory: 1024 MB (1 GB) / タスク
- NAT Gateway: 2個（高可用性）
- ALB: 1個
- DynamoDB: PAY_PER_REQUEST（4テーブル）
- SQS: Standard Queue（2キュー）
- S3: 2バケット（reports, cloudtrail）
- API Gateway: HTTP API
- CloudWatch Logs: 2ロググループ
- CloudTrail: 1トレイル（マルチリージョン）
- KMS: 4キー

---

## 1日あたりのコスト詳細

### 1. VPC & Networking

#### NAT Gateway (2個)
- **時間料金**: $0.045/時間 × 2個 × 24時間 = **$2.16/日**
- **データ転送**: アイドル状態でほぼ0GB ≈ **$0/日**
- **Elastic IP (2個)**: 無料（EC2インスタンスにアタッチされている場合）
- **小計**: **$2.16/日**

#### VPC Endpoints
- **S3 Gateway Endpoint**: 無料
- **DynamoDB Gateway Endpoint**: 無料
- **小計**: **$0/日**

#### VPC自体
- VPC、サブネット、ルートテーブル: 無料
- **小計**: **$0/日**

**VPC合計**: **$2.16/日**

---

### 2. ECS Fargate

#### Auth Service (2タスク)
- **vCPU**: 0.5 vCPU × 2タスク × 24時間 × $0.04048/vCPU時間 = **$0.97/日**
- **Memory**: 1 GB × 2タスク × 24時間 × $0.004445/GB時間 = **$0.21/日**

#### Report Worker (2タスク)
- **vCPU**: 0.5 vCPU × 2タスク × 24時間 × $0.04048/vCPU時間 = **$0.97/日**
- **Memory**: 1 GB × 2タスク × 24時間 × $0.004445/GB時間 = **$0.21/日**

#### ECS Cluster
- Container Insights: 有効（追加コストなし）
- **小計**: **$0/日**

**ECS合計**: **$2.36/日**

---

### 3. Application Load Balancer (ALB)

#### 基本料金
- **時間料金**: $0.0225/時間 × 24時間 = **$0.54/日**

#### LCU (Load Balancer Capacity Units)
- アイドル状態: 最小LCU ≈ 0.25 LCU
- **LCU料金**: 0.25 LCU × 24時間 × $0.008/LCU時間 = **$0.048/日**

#### データ転送
- アイドル状態でほぼ0GB ≈ **$0/日**

**ALB合計**: **$0.59/日**

---

### 4. DynamoDB

#### PAY_PER_REQUEST料金
- **リクエスト**: なし（アイドル状態）
- **読み取り**: 0リクエスト × $1.25/百万 = **$0/日**
- **書き込み**: 0リクエスト × $1.25/百万 = **$0/日**

#### ストレージ
- テーブル4個、データなし ≈ **$0/日**

#### Point-in-Time Recovery
- 有効だが、バックアップストレージなし ≈ **$0/日**

**DynamoDB合計**: **$0/日**

---

### 5. S3

#### ストレージ料金
- Reportsバケット: データなし ≈ **$0/日**
- CloudTrailバケット: ログ少量（1日分）≈ 0.01 GB × $0.025/GB/月 ÷ 30 = **$0.000008/日**

#### リクエスト
- PUT: なし ≈ **$0/日**
- GET: なし ≈ **$0/日**

#### データ転送
- なし ≈ **$0/日**

**S3合計**: **$0.000008/日** ≈ **$0/日**

---

### 6. SQS

#### Standard Queue料金
- **リクエスト**: なし（アイドル状態）
- 送信/受信: 0リクエスト × $0.40/百万 = **$0/日**

#### データ転送
- なし ≈ **$0/日**

**SQS合計**: **$0/日**

---

### 7. API Gateway (HTTP API)

#### リクエスト料金
- **リクエスト**: なし（アイドル状態）
- $0.90/百万リクエスト × 0 = **$0/日**

#### データ転送
- なし ≈ **$0/日**

**API Gateway合計**: **$0/日**

---

### 8. CloudWatch Logs

#### ストレージ料金
- ECS Logs: 少量（1日分）≈ 0.1 GB × $0.50/GB/月 ÷ 30 = **$0.0017/日**
- API Gateway Logs: 少量 ≈ 0.01 GB × $0.50/GB/月 ÷ 30 = **$0.00017/日**

#### データ取り込み
- 少量 ≈ **$0/日**

#### メトリクス・アラーム
- カスタムメトリクス: 2個 × $0.30/メトリクス/月 ÷ 30 = **$0.02/日**

**CloudWatch合計**: **$0.022/日**

---

### 9. CloudTrail

#### トレイル料金
- **最初のトレイル**: 無料
- **マルチリージョン**: 無料（最初のトレイル）

#### イベント記録
- 管理イベント: 少量（1日分）≈ 1,000イベント × $2.00/100,000 = **$0.02/日**

#### S3ストレージ
- CloudTrailログ: 既にS3で計算済み

**CloudTrail合計**: **$0.02/日**

---

### 10. KMS

#### キー管理料金
- **キー数**: 4キー（DynamoDB, S3, SQS, CloudTrail）
- **料金**: $1.00/月/キー × 4キー ÷ 30 = **$0.133/日**

#### API呼び出し
- アイドル状態で少量 ≈ **$0/日**

**KMS合計**: **$0.133/日**

---

### 11. Secrets Manager

#### シークレット保存料金
- JWT Secret: 1個 × $0.40/月 ÷ 30 = **$0.013/日**

#### API呼び出し
- アイドル状態で少量 ≈ **$0/日**

**Secrets Manager合計**: **$0.013/日**

---

### 12. Amazon Bedrock

#### LLM推論
- **リクエスト**: なし（リリース前）
- Claude 3 Sonnet: 0リクエスト = **$0/日**

**Bedrock合計**: **$0/日**

---

## 1日あたりの総コスト

| カテゴリ | コスト（USD/日） | コスト（円/日）* |
|---------|----------------|----------------|
| VPC & Networking | $2.16 | ¥324 |
| ECS Fargate | $2.36 | ¥354 |
| ALB | $0.59 | ¥89 |
| DynamoDB | $0.00 | ¥0 |
| S3 | $0.00 | ¥0 |
| SQS | $0.00 | ¥0 |
| API Gateway | $0.00 | ¥0 |
| CloudWatch | $0.022 | ¥3 |
| CloudTrail | $0.02 | ¥3 |
| KMS | $0.133 | ¥20 |
| Secrets Manager | $0.013 | ¥2 |
| Bedrock | $0.00 | ¥0 |
| **合計** | **$5.30** | **¥795** |

*為替レート: 1 USD = 150 JPY（概算）

---

## 月額コスト見積もり（アイドル状態）

- **月額（30日）**: $5.30 × 30 = **$159/月** ≈ **¥23,850/月**

---

## コスト削減の推奨事項

### 1. NAT Gatewayの削減（最大の削減効果）
- **現状**: 2個（高可用性）
- **削減案**: 1個に削減
- **削減額**: $2.16/日 → $1.08/日（**$1.08/日削減**）

### 2. ECSタスク数の削減
- **現状**: 各サービス2タスク
- **削減案**: 各サービス1タスク（dev環境）
- **削減額**: $2.36/日 → $1.18/日（**$1.18/日削減**）

### 3. ALBの削減
- **現状**: ALB使用
- **削減案**: 開発環境では直接ECSタスクにアクセス（ALB削除）
- **削減額**: $0.59/日削減

### 4. CloudTrailの簡素化
- **現状**: マルチリージョン
- **削減案**: シングルリージョンのみ
- **削減額**: ほぼ同じ（最初のトレイルは無料）

### 削減後の1日あたりコスト
- **削減後**: $1.08 + $1.18 + $0.00 + $0.022 + $0.02 + $0.133 + $0.013 = **$2.45/日**
- **削減額**: $5.30 - $2.45 = **$2.85/日**（約54%削減）
- **月額削減後**: **$73.5/月** ≈ **¥11,025/月**

---

## 注意事項

1. **NAT Gatewayが最大のコスト要因**（約41%）
2. **ECS Fargateが2番目**（約45%）
3. **リリース後のBedrockコスト**は別途計算が必要（使用量に応じて変動）
4. **データ転送料金**は実際の使用量に応じて追加
5. **CloudWatch Logs**はログ量に応じて増加する可能性あり

---

## 参考: AWS公式料金ページ
- [AWS Pricing Calculator](https://calculator.aws/)
- [ap-northeast-1 料金](https://aws.amazon.com/jp/pricing/)
